# octobercms-soulstrology-theme
This is an [OctoberCMS](https://docs.octobercms.com/2.x/setup/installation.html#installing-composer) theme for an Astrology Web App called Soulstrology.

MAIN FEATURES

1. Content Based Membership Platform
2. E-Commerce
3. Birth Chart Calculator


## CONTENT BASED MEMBERSHIP PLATFORM
The Membership Platform was built using [Stripe API](https://stripe.com/docs/api) and [RainLab User-Plugin](https://github.com/rainlab/user-plugin). Stripe is used  to manage the subscriptions, you can find more details on how it works [here](https://stripe.com/docs/billing/subscriptions/overview). RainLab User-Plugin is used for front end user management.

### **INITIAL STRIPE SET-UP**

If you haven't already, you'll need to create an account with [Stripe](https://stripe.com/) and create *live* Secret and Public API keys. 

Locate the `stripe.js` and `profilestripe.js` files located in `themes/soulstology/assets/vendor`. Update the files with your own Public Keys.

```
// Create a Stripe client.
var stripe = Stripe('[ YOUR STRIPE PUBLIC KEY ]');
```

These 3 script files work with `<script src="https://js.stripe.com/v3/"></script>` found in the site templates. 


### MEMBERSHIP REGISTRATION
I created a plugin found in `plugins/abrabinah/registration` to process this Membership Registration. It uses [RainLab User-Plugin](https://github.com/rainlab/user-plugin), [Stripe API](https://stripe.com/docs/api), and [MailChimp](https://mailchimp.com/). Locate the `Plugin.php` to update the Stripe and MailChimp API keys to your own configuration. Here's what this plugin does:

1. It first checks for all the required parameters: First Name, Last Name, Email, Password, StripeToken (CC), and Membership Plan. It will throw an error if there's any duplicate data from the database, missing data from the form, or missing StripeToken.

2. It creates a new *Active Subscription* and *Client Profile* in your Stripe Account by passing the following: Name, Email, Membership Plan, and StripeToken. 

3. It creates an Account in your own database then adds the following: First Name, Last Name, Email, and newly created StripeID. The StripeID is a unique code generated by Stripe that identifies a Subscription for a Client.  

3. Adds the new Member's email to your MailChimp account.

4. Once it completes, it flashes a success note and sends the new Member a welcome email. 


The Membership Registration Form is in a modal found in `themes/soulstrology/partials/membership-registration.htm`. It's activated by *SIGN UP NOW!* in the Navbar.





### MEMBER REALM
The `member-realm.htm` is the main page where Member's can access their content. This page and `member-post.htm` is restricted to *active* Stripe Subscriptions. It runs the code below to validate the subscription using the StripeID connected to the User's account. If the Subscription doesn't check out, the User will be redirected to the **MY PROFILE** page (see the next section). To activate this feature update the pages with your Stripe Secret Key.   

```
function onStart()
{ 
    $user = \Auth::getUser();
    
    $stripe_id = $user-> stripe_id;
    
    \Stripe\Stripe::setApiVersion("2019-05-16");

    \Stripe\Stripe::setApiKey("[ YOUR STRIPE SECRET KEY ]");
    
    $data = \Stripe\Customer::retrieve( $stripe_id );
    
    $id = $data->subscriptions->data;
     
    if ( $id == FALSE ) {
        // This user is not a paying customer...
        return redirect('my-profile');   
    }
}
```


### MY PROFILE
Using the code below in the `my-profile.htm`, the below lists out the features for the User when they are on this page. To activate these features update the pages with your Stripe Secret Key and MailChimp API Keys.

```
function onStart()
{
    $user = \Auth::getUser();
    
    $stripe_id = $user-> stripe_id;
    
    \Stripe\Stripe::setApiVersion("2019-05-16");

    \Stripe\Stripe::setApiKey("[ YOUR STRIPE SECRET KEY ]");

    $this['data'] = \Stripe\Customer::retrieve( $stripe_id );
}
```

1. Shows what Membership Plan their on.

2. Shows the last 4 digits of the Credit Card used for their Membership.

3. They can update their Credit Card.
```
function onStart()
{
        \Stripe\Stripe::setApiVersion("2019-05-16");
        
        $user = \Auth::getUser();
        
        $token = $_POST['stripeToken'];
            if ( ! $token) {
            throw new \RuntimeException('Stripe token is missing!');
        }
        
        $user->updateCard($token);
        
        return redirect('my-profile');
}
```

4. They can cancel their Membership. 
```
function onStart()
{       
        \Stripe\Stripe::setApiVersion("2019-05-16");
        
        \Stripe\Stripe::setApiKey("[ YOUR STRIPE SECRET KEY ]");
        
        $user = \Auth::getUser();
        
        $stripe_id = $user-> stripe_id;
        
        $subscription = $_POST['subscription_id'];
        
        $sub = \Stripe\Subscription::retrieve( $subscription );            
        $sub->update(
            $subscription,
            [
            
                'cancel_at_period_end' => 'true',
                    
            ]
            );
        
        \Stripe\Customer::update(
          $stripe_id,
            [
                'description' => 'cancelled',
            ]
        );
        
        $data = [
          'email'     => $user-> email,
          'status'    => 'unsubscribed'
        ];

      $apiKey = '[ YOUR MAILCHIMP API KEY]';
      $listId = '[ YOUR MEMBERSHIP LIST ID ]';
      $memberId = md5(strtolower($data['email']));
      $dataCenter = substr($apiKey,strpos($apiKey,'-')+1);
      $url = 'https://' . $dataCenter . '.api.mailchimp.com/3.0/lists/' . $listId . '/members/' . $memberId;
      $json = json_encode([
      'email_address' => $data['email'],
      'status'        => $data['status'], // "subscribed","unsubscribed","cleaned","pending"

      ]);
      
      $ch = curl_init($url);
      curl_setopt($ch, CURLOPT_USERPWD, 'user:' . $apiKey);
      curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
      curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
      curl_setopt($ch, CURLOPT_TIMEOUT, 10);
      curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PATCH');
      curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
      curl_setopt($ch, CURLOPT_POSTFIELDS, $json);                                                                                                                 
      $result = curl_exec($ch);
      $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
      curl_close($ch);
        
      return redirect('my-profile');
}
```

5. They can resume their Membership.
```
function onStart()
{
       
        \Stripe\Stripe::setApiVersion("2019-05-16");
    
        \Stripe\Stripe::setApiKey("[ YOUR STRIPE SECRET KEY ]");
    
        $user = \Auth::getUser();
        
        $stripe_id = $user-> stripe_id;
        
        $new_plan = $_POST['new_plan'];
         
        $user->newSubscription('main', $new_plan )->create();
        
        \Stripe\Customer::update(
        $stripe_id,
            [
                'description' => $new_plan,
            ]
        );
        
        $data = [
          'email'     => $user-> email,
          'status'    => 'subscribed'
        ];

      $apiKey = '[ YOUR MAILCHIMP API KEY ]';
      $listId = '[ YOUR MEMBERSHIP LIST ID ]';
      $memberId = md5(strtolower($data['email']));
      $dataCenter = substr($apiKey,strpos($apiKey,'-')+1);
      $url = 'https://' . $dataCenter . '.api.mailchimp.com/3.0/lists/' . $listId . '/members/' . $memberId;
      $json = json_encode([
      'email_address' => $data['email'],
      'status'        => $data['status'], // "subscribed","unsubscribed","cleaned","pending"

      ]);
      
      $ch = curl_init($url);
      curl_setopt($ch, CURLOPT_USERPWD, 'user:' . $apiKey);
      curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
      curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
      curl_setopt($ch, CURLOPT_TIMEOUT, 10);
      curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PATCH');
      curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
      curl_setopt($ch, CURLOPT_POSTFIELDS, $json);                                                                                                                 
      $result = curl_exec($ch);
      $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
      curl_close($ch);
        
      return redirect('my-profile');
 
}
```






## E-COMMERCE
SnipCart was used to manage the physical and digital products. Activate this feature by creating an account with SnipCart and generate your API Keys with them. Add your API Keys in the designated SnipCart sections found at the botttom of the pages in `themes/soulstrology/layout/member-realm-template` and `themes/soulstrology/layout/main-website-template`

```
<!-- SnipCart -->
<link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.21/default/snipcart.css" />
<script async src="https://cdn.snipcart.com/themes/v3.0.21/default/snipcart.js"></script>
<div id="snipcart" data-api-key="[ YOUR SNIPCART API KEY ]" hidden></div>

```
Under `themes/soulstrology/pages`

For a Shop All template use `shop.htm`.

For a Physical Product Template use `im-cosmos-gold-foil-moon-phase-zip.htm`.  

For a Virtual Prroduct Template use `virtual-live-events.htm`.

Checkout Button can be found in the `header.htm`.




## BIRTH CHART CALCULATOR
The Birth Chart Calculator was created using the Western Astrology feature from [AstrologyAPI](https://astrologyapi.com/) and [Google Geocoding API](https://developers.google.com/maps/documentation/geocoding/overview).

The `birth-chart-calculator.htm` is the form a User fills out. Once this form is submitted, it sends a request to Astrology API. The `birth-charts-results.htm` provides the results.

### BIRTH CHART FORM 
The Birth Chart requires these parameters: Name=>'name', Birth Day=>'day', Birth Month=>'month', Birth Year=>'year', Birth Hour=>'hour', Birth Minute=>'min', Birth Place Latitude=>'lat', Birth Place Longitude=>'lon', and Birth Time Time Zone=>'tzone'.

The [Google Geocoding API](https://developers.google.com/maps/documentation/geocoding/overview) script below the form is activated when the User starts to enter their Birth Location. Once the User selects their Birth Location from the Google populated list, a request is sent to source the Latitude and Longtitude. The script drops those points in the designated hidden 'lat' and 'lon' fields in the form. The script ends with some math to find the 'tzone' and drops it into a hidden field in the form. 


```
<div class="form-group">
<div class="col-lg-6 col-xs-12 col-sm-12">
<div class="on_the_cosmos">
<div class="portlet light box-shadow-depth-1 bordered">
<div class="portlet-title">
<div class="caption">
<span class="caption-subject bold"><h4>BIRTH CHART CALCULATOR</h4></span>
<span class="caption-helper">Fill out the following details to access a brief overview of your Birth Chart.</span>
<div class="portlet-body ">
<form class="form-horizontal astrology-form" role="form" method="post" action="https://soulstrology.com/birth-chart">

<div class="form-group " id="formErrorContiner">
<div class="col-md-12">
<label id="WhoroscopeFormError" class="font-red control-label display-none "></label>
</div>
</div>

<div class="form-group">
<div class="col-md-12">
<label for="name" class="control-label"><h1>NAME</h1></label>
<input type="text" class="form-control" name="name" placeholder="Name">
</div>
</div>

<div class="form-group">
<div class="row">
<div class="col-md-12">
<br></br>
<h1>DATE OF BIRTH</h1>
</div>
</div>
</div>

<div class="form-group">
<div class="row">
<div class="col-md-4">
<label for="date" class="control-label">date</label>
<input type="number" class="form-control" name="day" id="day" placeholder="DD">
</div>

<div class="col-md-4">
<label for="month" class="control-label">month</label>
<input type="number" class="form-control" name="month" id="month" placeholder="MM">
</div>

<div class="col-md-4">
<label for="year" class="control-label">year</label>
<input type="number" class="form-control" name="year" id="year" placeholder="YYYY">
</div>
</div>
</div>

<div class="form-group">
<div class="row">
<div class="col-md-12">
<br></br>
<h1>TIME OF BIRTH</h1>
<h6><p> Enter in 24-hour clock. </p></h6>
</div>
</div>
</div>

<div class="form-group">
<div class="row">
<div class="col-md-4">
<label for="hour" class="control-label">hour</label>
<input type="number" class="form-control" name="hour" id="hour" placeholder="HH">
</div>

<div class="col-md-4">
<label for="minute" class="control-label">minute</label>
<input type="number" class="form-control" name="min" id="min" placeholder="MM">
</div>

<div class="col-md-4"> <label for="" class="control-label">format</label> <input type="number" class="form-control" id="" placeholder="24 Hours" disabled> </div>
</div>
</div>

<div class="form-group">
<div class="row">
<div class="col-md-12">
<br></br>
<h1>PLACE OF BIRTH</h1>
<h6><p> After you begin entering the CITY, make sure to select your PLACE OF BIRTH from the list of recommendations. </p></h6>
</div>
</div>
</div>

<div class="form-group">
<div class="col-md-12">
<input id="place" type="text" class="form-control" name="place" placeholder="Los Angeles, CA United States">
<input type="hidden" name="lat" id="lat">
<input type="hidden" name="lon" id="lon">
<input type="hidden" name="tzone" id="tzone">
</div>
</div>

<div class="form-group margin-top-20">
<div class="col-md-12">
<button type="submit" id="generateWHoroscope" class="btn btn-primary" data-style="expand-right">
<span class="ladda-label">
<i class="icon-arrow-right"></i> CALCULATE CHART </span>
<span class="ladda-spinner"></span><div class="ladda-progress" style="width: 0px;"></div></button>
</table>
</div>
</div>

</form>

</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
    function activatePlacesSearch(){
        
        var input = document.getElementById('place');
        var options = {
                  types: ['(cities)'],
                    };
                    
        var autocomplete = new google.maps.places.Autocomplete(input, options);
        
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
            var place = autocomplete.getPlace();
            document.getElementById('lat').value = place.geometry.location.lat();
            document.getElementById('lon').value = place.geometry.location.lng();
                    var lat = document.getElementById('lat').value;
        var lon = document.getElementById('lon').value;
        var loc = [ lat, lon ];
        var year = document.getElementById('year').value;
        var month = document.getElementById('month').value - 1;
        var day = document.getElementById('day').value;
        var hour = document.getElementById('hour').value;
        var min = document.getElementById('min').value;
        var date = new Date( year, month, day, hour, min, 00, 0 );
        console.log(date);
        var timestamp = date / 1000;
        var ourRequest = new XMLHttpRequest();
        ourRequest.open('GET', 'https://maps.googleapis.com/maps/api/timezone/json?location='+ loc + '&timestamp=' + timestamp + '&key=AIzaSyBXEAYjBPbDub-KJ3IiVSs7Un2JXU29hQM');
        
        ourRequest.onload = function(){
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        var zoneOne = ourData.rawOffset + ourData.dstOffset;
        var zone = zoneOne / 3600;
        document.getElementById('tzone').value = zone;
        };
        ourRequest.send();
        });
        
    };
</script>

<script type="text/javascript" async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXEAYjBPbDub-KJ3IiVSs7Un2JXU29hQM&libraries=places&callback=activatePlacesSearch"></script>
```

### BIRTH CHART RESULTS
The `birth-chart-results.htm` page was built using the JSON data created by the Birth Chart Form that was submitted.




